<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0"><title>抽奖css3简化demo</title><link rel="stylesheet" href="/public/css/jsp/demo/rotaryDemo.css"></head><body><h3 style="text-align:center;">选饭大转盘</h3><div class="lottery-rotary"><canvas width="1096px" height="1096px"></canvas><a><span>点击<br>抽奖</span></a></div><script>var view = {
    // 一、main
    init:function(){
        var config = {
            // 2.奖盘模块选择器
            selector:'.lottery-rotary',
            // 4.奖品名
            name:[
                "面香八方","梅子",
                "羊汤","拉面",
                "巴依老爷", "宏状元",
                "车库", "全面俱到"
            ],
        };
        // 1.抽奖转盘功能
        view.initLotteryRotary(config);
        // 2.自动化绘制奖盘
        view.createTurnWheel(config);

    },
    // 二、logic
    // 
    
    // 三、individual
    // 1.抽奖转盘功能
    initLotteryRotary:function(config){
        var rotary = document.querySelector(config.selector),
            btn = rotary.querySelector('a'),
            img = btn.previousSibling,

            // 旋转标志
            rotateFlag = false,

            number = config.name.length,
            angleUnit = 360/number,
            angleBuffer = 360*5;
        
        
        view.bind(rotary,'click',function(){
            if(!rotateFlag){
                rotateFlag = true;
                
                var index = view.randomNum(0,number),
                    angleEnd = index*angleUnit,
                    angleRotate = angleEnd + angleBuffer;
                img.style.transition = 'transform 4s ease-out';
                img.style.transform = 'rotate('+angleRotate+'deg)';
                

                setTimeout(function(){
                    img.style.transition = 'none';
                    img.style.transform = 'rotate('+angleEnd+'deg)';
                    rotateFlag = false;
                    // ?
                    //- alert(config.name[index]);
                },4000)
                                            
            }
        });
    },
    // 2.自动化绘制奖盘
    createTurnWheel:function (config) {
        var turnWheel = {
            // 转盘奖品名称数组
            rewardNames: config.name,
            // 转盘外圆的半径
            outsideRadius: 274,
            // 转盘奖品位置距离圆心的距离
            textRadius: 240,
            // 转盘内圆的半径
            insideRadius: 20,
            // 开始角度
            startAngle: (-0.5-(2/config.name.length)/2)*Math.PI,
            // false:停止;ture:旋转
            bRotate: false,
        };

        view.drawWheel(turnWheel,config);
    },
    // 2.1 执行canvas图片绘制
    drawWheel:function (turnWheel,config) {
        // 获取canvas画板
        var canvas = document.querySelector(config.selector+'>canvas'),
            // 计算每块占的角度，弧度制
            baseAngle = Math.PI * 2 / (turnWheel.rewardNames.length),
            // 获取上下文
            ctx=canvas.getContext("2d");
            // // 画板的高度
            // canvasW = canvas.width,
            // // 画板的宽度
            // canvasH = canvas.height;

        // 让图像清晰适应高分屏放大2倍再缩回
        ctx.scale(2,2);
        var canvasW = canvas.width/2,
            canvasH = canvas.height/2;

        // 基准字体
        var fontStyle= {
                big:'bold 26px Microsoft YaHei',
                middle:'18px Microsoft YaHei',
                small:'14px Microsoft YaHei'
            },
            offsetHorizontal = function(HorizontalDirection,text,ctx){
                switch(HorizontalDirection){
                    case 'right':
                        return 0;
                    case 'left':
                        return -ctx.measureText(text).width;
                    case 'center':
                    default :
                        return -ctx.measureText(text).width / 2;
                }
            },
            creatCtxText = function(text,fontStyle,line_height,ctx,HorizontalDirection){
                ctx.font = fontStyle;
                ctx.fillText(text, offsetHorizontal(HorizontalDirection,text,ctx),line_height);
            };

        //在给定矩形内清空一个矩形
        ctx.clearRect(0,0,canvasW,canvasH);
        //strokeStyle 绘制颜色
        ctx.strokeStyle = "#ca1518";
        //font 画布上文本内容的当前字体属性
        ctx.font = '16px Microsoft YaHei';

        // 绘图
        for(var index = 0 ; index < turnWheel.rewardNames.length ; index++){
            // 当前的角度
            var angle = turnWheel.startAngle + index * baseAngle;
            // 填充颜色
            ctx.fillStyle = turnWheel.colors ? turnWheel.colors[index]
                : (
                    (index%2 == 0) ? '#ffeebe': '#fef9ee'
                );

            // 开始画内容
            // 1.基本的背景颜色
            ctx.beginPath();
            ctx.arc(canvasW * 0.5, canvasH * 0.5, turnWheel.outsideRadius, angle, angle + baseAngle, false);
            ctx.arc(canvasW * 0.5, canvasH * 0.5, turnWheel.insideRadius, angle + baseAngle, angle, true);
            // ctx.stroke(); // 边框
            ctx.fill();
            ctx.save();

            // 绘制奖品内容
            // 1.字体
            // 颜色
            ctx.fillStyle = "#ca1518";
            // 整体位置
            var rewardName = turnWheel.rewardNames[index],
                line_height = 26,
                translateX = canvasW * 0.5 + Math.cos(angle + baseAngle / 2) * turnWheel.textRadius,
                translateY = canvasH * 0.5 + Math.sin(angle + baseAngle / 2) * turnWheel.textRadius;
            ctx.translate(translateX,translateY);
            ctx.rotate(angle + baseAngle / 2 + Math.PI / 2);

            if(rewardName.indexOf("汇源天然苏打水") >= 0){
                creatCtxText('汇源',fontStyle.big,line_height,ctx,'left');
                creatCtxText('天然',fontStyle.middle,line_height,ctx,'right');
                creatCtxText('苏打水',fontStyle.middle,2*line_height,ctx);
            }else if(rewardName.indexOf("谢谢参与") >= 0){
                creatCtxText('谢谢',fontStyle.big,line_height,ctx);
                creatCtxText('参与',fontStyle.big,2*line_height,ctx);
            }else{
                ctx.fillText(rewardName, -ctx.measureText(rewardName).width / 2, 0);
            }

            //还原画板的状态到上一个save()状态之前
            ctx.restore();
        }
    },
    
    // 四、general
    // 1.事件操作
    /**
     * @description 事件移除，兼容各浏览器
     * @param target
     * 事件触发对象
     * @param type
     * 事件
     * @param func
     * 事件处理函数
     */
    // 1.1 添加
    bind:function(target, type, func) {
        if (target.addEventListener) {// 非ie 和ie9
            target.addEventListener(type, func, false);
        } else if (target.attachEvent) { // ie6到ie8
            target.attachEvent("on" + type, func);
        } else {
            target["on" + type] = func; // ie5
        }
    },

    // 返回在n和m之间的随机整数
    /*
    n<= random <=m
    */
    randomNum:function(n, m) {
        /* Math.floor(Math.random()*10);时，可均衡获取0到9的随机整数。 */
        var random = Math.floor(Math.random() * (m - n)) + n;
        //- console.log("rewardNames["+random*36+"]");
        return random;
    }
}

view.init();</script></body></html>